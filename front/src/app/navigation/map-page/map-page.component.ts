import {Component, OnInit, OnDestroy} from '@angular/core';
import * as Leaflet from 'leaflet';
import {LatLngExpression, LatLngLiteral, LeafletMouseEvent} from 'leaflet';
import {DataService} from '../../services/data.service';
import {IGpsCoordinate} from '../../building-objects-if';

const iconRetinaUrl = 'leaflet/marker-icon-2x.png';
const iconUrl = 'leaflet/marker-icon.png';
const shadowUrl = 'leaflet/marker-shadow.png';
const iconDefault = Leaflet.icon({
  iconRetinaUrl,
  iconUrl,
  shadowUrl,
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  tooltipAnchor: [16, -28],
  shadowSize: [41, 41]
});
Leaflet.Marker.prototype.options.icon = iconDefault;

@Component({
  selector: 'app-map-page',
  templateUrl: './map-page.component.html',
  styleUrls: ['./map-page.component.scss'],
})
export class MapPageComponent implements OnInit, OnDestroy {

  private readonly KV_CORNER_COORDINATES:LatLngExpression[] = [
    [49.452645,11.0924275],
    [49.45261,11.09275],
    [49.4520935,11.092615],
    [49.4521275,11.092297]
  ];

  private readonly KA_CORNER_COORDINATES:LatLngExpression[] = [
    [49.4530325,11.092505],
    [49.45301,11.092705],
    [49.452992,11.09269825],
    [49.452915,11.0933975],
    [49.452935,11.093398],
    [49.4529148,11.0935875],
    [49.45289,11.09358],
    [49.452835,11.0940575],
    [49.452777575,11.09403538],
    [49.45276,11.094245],
    [49.452858,11.0942725],
    [49.45283,11.09451],
    [49.45255525,11.0944425],
    [49.4525825,11.0942125],
    [49.45255,11.09420],
    [49.452571,11.0939825],
    [49.45266175,11.0940075],
    [49.452715,11.0935275],
    [49.452695,11.09352285],
    [49.452715,11.0933425],
    [49.452735,11.0933475],
    [49.45281175,11.09265],
    [49.452705,11.092625],
    [49.4527275,11.092422]
  ];

  private readonly KB_CORNER_COORDINATES:LatLngExpression[] = [
    [49.452445,11.09271],
    [49.4524275,11.0928575],
    [49.4525275,11.092885],
    [49.4525245,11.092965],
    [49.452545,11.0929725],
    [49.452539,11.0930575],
    [49.4525125,11.0930525],
    [49.452505,11.09312675],
    [49.4524625,11.093115],
    [49.452455,11.093169],
    [49.4522275,11.09311],
    [49.4522325,11.0930535],
    [49.45209875,11.09302075],
    [49.4521255,11.0927825],
    [49.4523425,11.0928375],
    [49.45236,11.092685]
  ];

  private readonly KL_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45247777405956,
      11.093304678797722
    ],
    [
      49.45204839923639,
      11.093194708228111
    ],
    [
      49.45200306401015,
      11.093617491424084
    ],
    [
      49.45226701033969,
      11.093698628246784
    ],
    [
      49.45226461281543,
      11.093723773956299
    ],
    [
      49.45230515275533,
      11.093733161687851
    ],
    [
      49.45230776823417,
      11.093709357082844
    ],
    [
      49.4524302596703,
      11.093740202486515
    ],
    [
      49.45247777405956,
      11.093304678797722
    ]
  ];

  private readonly KI_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45222821402363,
      11.093689240515232
    ],
    [
      49.45197276785001,
      11.09360910952091
    ],
    [
      49.45193593292505,
      11.0939447209239
    ],
    [
      49.45219312294724,
      11.094010770320892
    ],
    [
      49.45222821402363,
      11.093689240515232
    ]
  ];

  private readonly KS_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.452155416358906,
      11.094211265444756
    ],
    [
      49.45213318471523,
      11.094203554093838
    ],
    [
      49.45213776181916,
      11.094171367585659
    ],
    [
      49.45206518197778,
      11.094147227704525
    ],
    [
      49.45206060486706,
      11.09417874366045
    ],
    [
      49.45203553972935,
      11.094169691205025
    ],
    [
      49.45202137247194,
      11.094266250729559
    ],
    [
      49.45199608935624,
      11.094258204102516
    ],
    [
      49.451987371037454,
      11.094323247671127
    ],
    [
      49.45201287211552,
      11.094331294298172
    ],
    [
      49.45199652527215,
      11.094439253211021
    ],
    [
      49.452117055869344,
      11.094480156898497
    ],
    [
      49.452131876971166,
      11.094465404748917
    ],
    [
      49.452135146331266,
      11.094440594315529
    ],
    [
      49.452126210079825,
      11.094416454434395
    ],
    [
      49.45214582623934,
      11.094272285699844
    ],
    [
      49.4521613012041,
      11.094259209930897
    ],
    [
      49.45216391669062,
      11.094234399497509
    ],
    [
      49.452155416358906,
      11.094211265444756
    ]
  ];

  private readonly KJ_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45195969036503,
      11.094162985682486
    ],
    [
      49.45190890609862,
      11.094146892428398
    ],
    [
      49.45187752008791,
      11.094351075589657
    ],
    [
      49.45192983009459,
      11.094367504119873
    ],
    [
      49.45195969036503,
      11.094162985682486
    ]
  ];

  private readonly KR_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45210136293316,
      11.094655506312847
    ],
    [
      49.45192634276253,
      11.09459616243839
    ],
    [
      49.451896264513394,
      11.094805710017681
    ],
    [
      49.45195860057446,
      11.094825826585293
    ],
    [
      49.45194094596382,
      11.094945184886456
    ],
    [
      49.45207106683378,
      11.094989441335201
    ],
    [
      49.45208675977969,
      11.094887517392635
    ],
    [
      49.45203379606714,
      11.094870083034039
    ],
    [
      49.45205145064434,
      11.094743013381958
    ],
    [
      49.45208719569476,
      11.094755083322525
    ],
    [
      49.45210136293316,
      11.094655506312847
    ]
  ];

  private readonly KT_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45209417033571,
      11.095182560384274
    ],
    [
      49.4518402491741,
      11.095131263136864
    ],
    [
      49.451771810112376,
      11.095927879214287
    ],
    [
      49.45202594958632,
      11.095979511737823
    ],
    [
      49.45209417033571,
      11.095182560384274
    ]
  ];

  private readonly KM_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45269943461553,
      11.094597838819027
    ],
    [
      49.452425464637614,
      11.094528101384638
    ],
    [
      49.45243679835046,
      11.094415113329887
    ],
    [
      49.45227769021906,
      11.094376556575298
    ],
    [
      49.4522665744262,
      11.094488874077797
    ],
    [
      49.452207944026036,
      11.094472780823706
    ],
    [
      49.45219312294724,
      11.0946112498641
    ],
    [
      49.45225240723555,
      11.094627678394318
    ],
    [
      49.452240855523236,
      11.094732955098152
    ],
    [
      49.45274346146997,
      11.09486136585474
    ],
    [
      49.452756538745845,
      11.09474468976259
    ],
    [
      49.45268504959511,
      11.094726584851742
    ],
    [
      49.45269943461553,
      11.094597838819027
    ]
  ];

  private readonly KH_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.452767436473096,
      11.094929091632366
    ],
    [
      49.45223148337728,
      11.094790622591972
    ],
    [
      49.45218396874928,
      11.095229834318161
    ],
    [
      49.452243688962355,
      11.095244586467743
    ],
    [
      49.45222886789438,
      11.095378026366234
    ],
    [
      49.452163698733415,
      11.095360592007637
    ],
    [
      49.45214081322154,
      11.09556745737791
    ],
    [
      49.45231103758253,
      11.095610372722149
    ],
    [
      49.452333923014926,
      11.095404848456383
    ],
    [
      49.45231125553908,
      11.095400154590607
    ],
    [
      49.4523254227127,
      11.095268391072748
    ],
    [
      49.452719050545674,
      11.095370315015316
    ],
    [
      49.452767436473096,
      11.094929091632366
    ]
  ];

  private readonly KY_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45253880164793,
      11.095610372722149
    ],
    [
      49.45250044145838,
      11.09545849263668
    ],
    [
      49.45240257924797,
      11.095435693860054
    ],
    [
      49.45237097559707,
      11.09572235494852
    ],
    [
      49.45253880164793,
      11.095610372722149
    ]
  ];

  private readonly WF_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45279751418767,
      11.0959979519248
    ],
    [
      49.452629906977755,
      11.09607707709074
    ],
    [
      49.45263775336188,
      11.096114628016949
    ],
    [
      49.45259721369706,
      11.096134409308432
    ],
    [
      49.45263077879827,
      11.096243374049664
    ],
    [
      49.452828027792314,
      11.096152178943155
    ],
    [
      49.45279751418767,
      11.0959979519248
    ]
  ];

  private readonly WK_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.45263077879827,
      11.096243374049664
    ],
    [
      49.45258217478062,
      11.096084788441658
    ],
    [
      49.4523134351045,
      11.096218898892403
    ],
    [
      49.45234743631284,
      11.096383854746817
    ],
    [
      49.45263077879827,
      11.096243374049664
    ]
  ];

  private readonly W_CORNER_COORDINATES:LatLngExpression[] = [
    [
      49.452943979316714,
      11.096445880830288
    ],
    [
      49.45290583739818,
      11.096798926591873
    ],
    [
      49.452409771800156,
      11.096665486693382
    ],
    [
      49.4525915468595,
      11.09708458185196
    ],
    [
      49.45271839668146,
      11.097116768360138
    ],
    [
      49.45269485756405,
      11.097322627902031
    ],
    [
      49.4525649563054,
      11.097287088632584
    ],
    [
      49.452589367306445,
      11.097085252404213
    ],
    [
      49.452407592239005,
      11.096664816141129
    ],
    [
      49.452393643045305,
      11.096790209412575
    ],
    [
      49.45238492479723,
      11.096784844994545
    ],
    [
      49.45231779423509,
      11.097356155514717
    ],
    [
      49.45267872890302,
      11.09745740890503
    ],
    [
      49.45266695933619,
      11.097567379474638
    ],
    [
      49.452987352090894,
      11.097623035311699
    ],
    [
      49.45305448173604,
      11.097413152456284
    ],
    [
      49.45292414552278,
      11.097376942634583
    ],
    [
      49.45294812043753,
      11.097175776958466
    ],
    [
      49.453078892493295,
      11.097204610705374
    ],
    [
      49.45305622536197,
      11.097413823008537
    ],
    [
      49.45298909571919,
      11.097622364759445
    ],
    [
      49.452972531247745,
      11.097749769687653
    ],
    [
      49.45309545692879,
      11.097792014479637
    ],
    [
      49.453099815989845,
      11.097773909568787
    ],
    [
      49.453266331831486,
      11.097811460494993
    ],
    [
      49.45335264086711,
      11.09772093594074
    ],
    [
      49.453324743013646,
      11.097604259848595
    ],
    [
      49.4532515110727,
      11.097683385014534
    ],
    [
      49.45319876657126,
      11.097670644521711
    ],
    [
      49.45323625440458,
      11.097350120544434
    ],
    [
      49.45328376801254,
      11.097370907664297
    ],
    [
      49.45333912784631,
      11.097496300935745
    ],
    [
      49.453326486629955,
      11.097602248191833
    ],
    [
      49.45335482038625,
      11.097719259560108
    ],
    [
      49.45336702569161,
      11.097744405269623
    ],
    [
      49.453350025444024,
      11.097767874598503
    ],
    [
      49.45332975591035,
      11.09794657677412
    ],
    [
      49.4535289636519,
      11.098000556230545
    ],
    [
      49.453553810074915,
      11.097753122448921
    ],
    [
      49.45340168002421,
      11.097706854343414
    ],
    [
      49.45338991063099,
      11.097681038081646
    ],
    [
      49.45340102616911,
      11.097667962312697
    ],
    [
      49.453424564947404,
      11.097450368106365
    ],
    [
      49.45329161429201,
      11.09716471284628
    ],
    [
      49.45325652397692,
      11.09721165150404
    ],
    [
      49.45323516464237,
      11.097212992608547
    ],
    [
      49.45323974164341,
      11.097194887697697
    ],
    [
      49.45329815285724,
      11.097132861614227
    ],
    [
      49.45324933154898,
      11.097030267119408
    ],
    [
      49.45317086863022,
      11.097111739218235
    ],
    [
      49.45311332907662,
      11.096982322633266
    ],
    [
      49.45316563776449,
      11.096503213047981
    ],
    [
      49.453131419170816,
      11.0964210703969
    ],
    [
      49.453093277398125,
      11.096481420099735
    ],
    [
      49.452943979316714,
      11.096445880830288
    ]
  ];

  map: Leaflet.Map;
  private _dataservice: DataService;

  constructor(dataservice: DataService) {
    this._dataservice = dataservice;
  }

  ngOnInit() { }
  async ionViewDidEnter() { await this.initializeMap(); }

  private async initializeMap() {
    const southWest = Leaflet.latLng(49.4126, 11.0111);
    const northEast = Leaflet.latLng(49.5118, 11.2167);
    const bounds = Leaflet.latLngBounds(southWest, northEast);

    // maxZoom for leaflet map is 18
    this.map = Leaflet.map('mapId', {
      maxBounds:bounds,
      maxZoom: 18,
      minZoom: 14
    }).setView([49.452858, 11.093235], 17);

    Leaflet.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'edupala.com © Angular LeafLet',
    }).addTo(this.map);


    const buildings = await this._dataservice.get_buildings().toPromise();

    function convertToLeafLetCoordinates(body: IGpsCoordinate[]) {
        const leafletBody:LatLngLiteral[] = []
        for (const coordinate of body){
          leafletBody.push({lat: coordinate.Latitude, lng: coordinate.Longitude});
        }

        return leafletBody;
    }

    if (buildings !== null) {
      for (const building of buildings) {
        if (building.Body !== null && building.Body.length > 0) {
          Leaflet.polygon(convertToLeafLetCoordinates(building.Body),
              {className: building.Name, color: building.Color ?? '#0083C6'})
              .addTo(this.map)
              .on('click', this.onPolygonClick);
        }
      }
    }

     Leaflet.marker([49.452858, 11.093235]).
      addTo(this.map).
      bindPopup('Technische Hochschule Nürnberg Georg Simon Ohm').
      openPopup();
  }

  private onPolygonClick(event:LeafletMouseEvent) : void
  {
    console.log(event.latlng, event.target.options.className);
    document.getElementById('close-open-map').click();
  }

  /** Remove map when we have multiple map object */
  ngOnDestroy() {
    this.map.remove();
  }
}
